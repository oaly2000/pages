---
title: 表单仔完全攻略
date: 2024-12-04
tags:
  - form
disable-math: false
---

过去三年的工作中, 出了偶尔写一些小的全栈项目和傻逼套壳客户端, 其实大部分时间都是在写表单, 各种各样的表单. 记录下心得, 后面开始新的学习.

#### 简单表单

关于表单和表格的封装, 我个人是持支持态度的, 对于并不复杂的的表单, 使用类似 json 的配置能够减少代码量, 同时使代码中的 HTML
部分更加简洁便于阅读, 但对于复杂的表单, 这种配置就会显得力不从心, 我们需要在适当的时候使不同的方式进行处理, 或者,
我们要封装出一个足够应对各种场景的表单方案.

```typescript
export type FieldObjectOption<C = typeof ElInput, K extends string = string> = {
  Component?: C;
  field: Partial<Omit<FormItemProps, "prop"> & { prop: K }> | string;
} & Partial<Mutable<ComponentInstance<C>["$props"]>>;

export type FieldOption<C = typeof ElInput> = FieldObjectOption<C> | (() => FieldObjectOption<C>);
```

这个是我基于 element-plus 封装的表单配置, 有了有几个项目了, 可以看到这个类型就只是把组件、组件参数和 FormItem 参数合在一起,
咋看下似乎没有起到减少代码的作用, 但仔细一想就会发现, Component 是有默认值的, 组件参数如 modelValue、placeholder 也是有默认值的,
那么这样就减轻了很多代码量.

同时, 这个配置可以通过传入组件来给出组件参数和字段名的提示, 在有 TypeScript 加持的情况下, 这写个表单就是纯纯体力活了.
而下面还有个函数形式的, 这是因为有时候我们的配置项居然是不确定的, 那就只好写个函数调用获取了. 对于任意组件库都可以参照这个思路,
手动字符串配置既复杂, 写的时候还有没类型支持.

当然了, 眼尖的一眼就能看出这个配置的局限性, 如果我有个 Select 组件, 里面的选项咋传进去? 其实也简单, 我们知道函数组件的签名类似
`(props, ctx) => VNode` , 那么你直接传入一个函数组件便是了, 当然了, 为了一些高级功能封装一个有状态的组件是更更好的选择.

#### 表单布局不要他妈用配置

我见过一个很奇妙的操作是表单布局居然用配置来解决, 先不说配置项搞得又臭又长, 处理配置项的逻辑也颇为复杂,
本来表单可以提取配置的基础就是基本没有什么 UI 逻辑, 都是数据相关的逻辑, 这才又了一个简单的表单配置, 但布局一加入显然就出问题了, 如果 JS
对象也是一层套一层写各种 UI 相关的东西, 那么为什么不直接写 HTML 呢?

其实, 以现代 CSS 的能力, 表单布局完全可以几条规则完事, HTML 与 CSS 分离是有道理的.

#### 嵌套表单和动态表单

接手过不知道多少个屎山项目之后, 我明白了, 大多数开发团队都他妈草台班子, 后端研究他妈的高并发高可用结果结果接口都跑不通, 前端研究什么 fiber
结果弹窗都弹歪了. 嵌套表单和动态表单的问题就是这样, 并不是有什么难度, 而是有些人瞎几把搞.

屎山太长, 而且都是公司代码不便贴出, 我总结问题如下:

1. 数据多态处理不当

   假设我们要的数据是如下结构, 你会怎么操作呢?

   ```typescript
   type ABC =
     | { type: "A"; values: {/* n fields, some of them is calculated by 'A' */} }
     | { type: "B"; values: {/* n fields, some of them is calculated by 'B' */} }
     | { type: "C"; values: {/* n fields, some of them is calculated by 'C' */} };
   ```

   在 values对应的子组件监听 type 字段, 然后变更这些依赖于其的字段? 恭喜你, 迈出了屎山第一步. 合理操作是当 type 变化时直接更改整个 values
   对象, 对几种多态直接编写多个组件, 当然了, 这并不代表代码的重复, 组件下面还有粒度更小的函数等东西可以复用

2. 代码组织不当

   react 那边使用 react-hook-form 有一个好处就是你是知道自己在操作什么数据的, 但 vue 这边却是不同.

   vue 具有响应式数据, 我们可以直接将数据往下传, 下面直接改数据, 于是就出毛病了, vue 写法近似原来的 HTML+CSS, 同时 SFC 不便于封装小组件,
   这使得许多 vuer 没有组件化的意识, 于是一个充斥着各种循环分支的长串模版代码出现了, 到了实在不得不写组件的时候, 又写个组件,
   数据的传递在这种情况下是杂乱无章、难以追踪的.

   该如何做呢? 答案是单一职责, 每个组件只做一件事, 控制动态表单如数组这种东西可以单独搞一个, 这是可以复用的, 下面的数据也是如此,
   一个对象对应一个组件, 如此一来每层组件的逻辑都较为简单, 组件间数据的传递也就一个对象, 逻辑简单清晰且追溯方便.

把这些操作一搞, 其实组件又可以塞回一开始那个简单的表单配置里了
